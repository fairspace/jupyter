#! /usr/bin/env bash

echo "
envs_dirs:
  - /home/jovyan/my-conda-envs/
" > ~/.condarc

NODE_PATH=/opt/proxy/ node /opt/proxy/app.js &

# Wait for proxy to start
sleep 2

sudo dav_mount "http://localhost:3000/api/webdav" "/home/jovyan/collections" || {
  echo "Error mounting webdav endpoint collections" >&2
  exit 1
}

if [ ! -z "${EXTERNAL_TARGETS}" ]; then
    IFS=','
    for target in $EXTERNAL_TARGETS; do
        sudo dav_mount "http://localhost:3000/api/storages/${target}/webdav" "/home/jovyan/${target}" || {
          echo "Error mounting webdav endpoint ${target}" >&2
          exit 1
        }
    done
fi

${JUPYTER_COMMAND} $@
